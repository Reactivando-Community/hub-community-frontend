'use client';

import { CommunityFormDialog } from '@/components/admin/community-form-dialog';
import { LocationFormDialog } from '@/components/admin/location-form-dialog';
import { ProductFormDialog } from '@/components/admin/product-form-dialog';
import { TalkFormDialog } from '@/components/admin/talk-form-dialog';
import { Button } from '@/components/ui/button';
import { Combobox } from '@/components/ui/combobox';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { RichTextEditor } from '@/components/ui/rich-text-editor';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { GET_COMMUNITIES, GET_LOCATIONS } from '@/lib/queries';
import { Community, EventLocation, Product, Talk } from '@/lib/types';
import { useQuery } from '@apollo/client';
import { zodResolver } from '@hookform/resolvers/zod';
import {
  Calendar,
  MapPin,
  Plus,
  Trash2,
  User as UserIcon,
  Users,
} from 'lucide-react';
import { useRouter } from 'next/navigation';
import { useEffect, useState } from 'react';
import { useForm } from 'react-hook-form';
import * as z from 'zod';

const eventSchema = z.object({
  title: z.string().min(2, {
    message: 'O título deve ter pelo menos 2 caracteres.',
  }),
  slug: z.string().min(2, {
    message: 'O slug deve ter pelo menos 2 caracteres.',
  }),
  start_date: z.string({
    required_error: 'A data de início é obrigatória.',
  }),
  end_date: z.string({
    required_error: 'A data de término é obrigatória.',
  }),
  max_slots: z.coerce.number().min(1, {
    message: 'O número de vagas deve ser pelo menos 1.',
  }),
  pixai_token_integration: z.string().optional(),
  description: z.any().optional(), // Complex type, validating as any for now
  location: z.any().optional(), // Stores the ID or object during interaction
  communityId: z.string().optional(),
  talks: z.array(z.any()).optional(),
  products: z.array(z.any()).optional(),
});

type EventFormValues = z.infer<typeof eventSchema>;

interface EventFormProps {
  initialData?: EventFormValues & { id?: string }; // Adjust based on actual data structure
  onSubmit: (data: EventFormValues) => Promise<string | undefined>;
  isLoading?: boolean;
}

// Mock locations - deprecated, now using GET_LOCATIONS
const MOCK_LOCATIONS: { label: string; value: string; data: EventLocation }[] =
  [];

// Mock communities - deprecated, now using GET_COMMUNITIES
const MOCK_COMMUNITIES: {
  label: string;
  value: string;
  data: Partial<Community>;
}[] = [];

export function EventForm({
  initialData,
  onSubmit,
  isLoading,
}: EventFormProps) {
  const router = useRouter();
  const isEditing = !!initialData?.id;

  // Location State
  const [locations, setLocations] = useState(MOCK_LOCATIONS);
  const [selectedLocationId, setSelectedLocationId] = useState<
    string | undefined
  >(initialData?.location?.id);

  const { data: locationsData } = useQuery(GET_LOCATIONS);

  useEffect(() => {
    if (locationsData?.locations?.data) {
      const options = locationsData.locations.data.map((loc: any) => ({
        label: loc.title || 'Sem título',
        value: loc.id,
        data: loc,
      }));
      setLocations(options);

      // If we have initialData and the location is in the list, ensure it's selected
      const initialLocId = initialData?.location?.id;
      if (initialLocId && !selectedLocationId) {
        setSelectedLocationId(initialLocId);
      }
    }
  }, [locationsData, initialData, selectedLocationId]);

  // Community State
  const [communities, setCommunities] = useState(MOCK_COMMUNITIES);
  const [selectedCommunityId, setSelectedCommunityId] = useState<
    string | undefined
  >(initialData?.communityId);

  const { data: communitiesData } = useQuery(GET_COMMUNITIES);

  useEffect(() => {
    if (communitiesData?.communities?.data) {
      const options = communitiesData.communities.data.map((comm: any) => ({
        label: comm.title,
        value: comm.id,
        data: comm,
      }));
      setCommunities(options);

      // If we have initialData and the community is in the list, ensure it's selected
      if (initialData?.communityId && !selectedCommunityId) {
        setSelectedCommunityId(initialData.communityId);
      }
    }
  }, [communitiesData, initialData, selectedCommunityId]);

  // Talks State
  const [talks, setTalks] = useState<Talk[]>(initialData?.talks || []);

  // Products State
  const [products, setProducts] = useState<Product[]>(
    initialData?.products || []
  );

  const form = useForm<EventFormValues>({
    resolver: zodResolver(eventSchema),
    defaultValues: initialData || {
      title: '',
      slug: '',
      start_date: '',
      end_date: '',
      max_slots: 0,
      pixai_token_integration: '',
      description: [],
      location: undefined,
      communityId: undefined,
      talks: [],
      products: [],
    },
  });

  const generateSlug = () => {
    const title = form.getValues('title');
    const slug = title
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)+/g, '');
    form.setValue('slug', slug);
  };

  const handleAddLocation = (newLocation: EventLocation) => {
    if (newLocation.id) {
      setSelectedLocationId(newLocation.id);
      form.setValue('location', newLocation.id);
    }
  };

  const handleLocationSelect = (id: string) => {
    setSelectedLocationId(id);
    const loc = locations.find(l => l.value === id);
    if (loc) {
      form.setValue('location', loc.data);
    }
  };

  // Community Handlers
  const handleAddCommunity = (newCommunity: any) => {
    const newOption = {
      label: newCommunity.title,
      value: newCommunity.id,
      data: newCommunity,
    };
    setCommunities(prev => [...prev, newOption]);
    setSelectedCommunityId(newCommunity.id);
    form.setValue('communityId', newCommunity.id);
  };

  const handleCommunitySelect = (id: string) => {
    setSelectedCommunityId(id);
    form.setValue('communityId', id);
  };

  // Talk Handlers
  const handleAddTalk = (newTalk: any) => {
    const talkWithId = { ...newTalk, id: newTalk.id || `talk-${Date.now()}` };
    const updatedTalks = [...talks, talkWithId];
    setTalks(updatedTalks);
    form.setValue('talks', updatedTalks);
  };

  const handleRemoveTalk = (id: string) => {
    const updatedTalks = talks.filter(t => t.id !== id);
    setTalks(updatedTalks);
    form.setValue('talks', updatedTalks);
  };

  // Product Handlers
  const handleAddProduct = (newProduct: any) => {
    const prod = { ...newProduct, id: newProduct.id || `prod-${Date.now()}` };
    const updatedProducts = [...products, prod];
    setProducts(updatedProducts);
    form.setValue('products', updatedProducts);
  };

  const handleSaveEventForTalk = async (): Promise<string | undefined> => {
    const isValid = await form.trigger();
    if (isValid) {
      return await onSubmit(form.getValues());
    }
    return undefined;
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-8">
        <Tabs defaultValue="general" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="general">Geral</TabsTrigger>
            <TabsTrigger value="schedule">Programação</TabsTrigger>
            <TabsTrigger value="products">Produtos & Lotes</TabsTrigger>
          </TabsList>

          <TabsContent value="general" className="space-y-6 mt-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <FormField
                control={form.control}
                name="title"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Título do Evento</FormLabel>
                    <FormControl>
                      <Input
                        placeholder="Ex: Workshop de React"
                        {...field}
                        onChange={e => {
                          field.onChange(e);
                        }}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="slug"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Slug (URL amigável)</FormLabel>
                    <div className="flex gap-2">
                      <FormControl>
                        <Input
                          placeholder="ex-workshop-de-react"
                          {...field}
                          disabled={isEditing}
                        />
                      </FormControl>
                      {isEditing ? (
                        <Button
                          type="button"
                          variant="outline"
                          onClick={() =>
                            window.open(
                              `/events/${field.value || initialData?.slug}`,
                              '_blank'
                            )
                          }
                        >
                          Ver página
                        </Button>
                      ) : (
                        <Button
                          type="button"
                          variant="outline"
                          onClick={generateSlug}
                        >
                          Gerar
                        </Button>
                      )}
                    </div>
                    <FormDescription>
                      Url que será usada para acessar o evento.
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <FormField
                control={form.control}
                name="start_date"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Data de Início</FormLabel>
                    <FormControl>
                      <Input
                        type="datetime-local"
                        className="block"
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="end_date"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Data de Término</FormLabel>
                    <FormControl>
                      <Input
                        type="datetime-local"
                        className="block"
                        {...field}
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="max_slots"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Vagas Máximas</FormLabel>
                    <FormControl>
                      <Input type="number" min={1} {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Location Section */}
            <div className="space-y-4 rounded-lg border p-4">
              <div className="flex items-center justify-between">
                <FormLabel className="text-base font-semibold">
                  Local do Evento
                </FormLabel>
                <LocationFormDialog
                  onSave={handleAddLocation}
                  trigger={
                    <Button type="button" variant="outline" size="sm">
                      <Plus className="mr-2 h-4 w-4" />
                      Novo Local
                    </Button>
                  }
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <FormItem className="flex-1">
                  <FormLabel>Selecionar Local</FormLabel>
                  <Combobox
                    options={locations}
                    value={selectedLocationId}
                    onSelect={handleLocationSelect}
                    placeholder="Selecione um local..."
                  />
                </FormItem>
                {selectedLocationId &&
                  (() => {
                    const loc = locations.find(
                      l => l.value === selectedLocationId
                    )?.data;
                    return loc ? (
                      <div className="text-sm text-muted-foreground pt-8">
                        <div className="flex items-center gap-1">
                          <MapPin className="h-4 w-4" />
                          <span>
                            {loc.city}/{loc.region} - {loc.full_address}
                          </span>
                        </div>
                      </div>
                    ) : null;
                  })()}
              </div>
            </div>

            {/* Community Section */}
            <div className="space-y-4 rounded-lg border p-4">
              <div className="flex items-center justify-between">
                <FormLabel className="text-base font-semibold">
                  Comunidade
                </FormLabel>
                <CommunityFormDialog
                  onSave={handleAddCommunity}
                  trigger={
                    <Button type="button" variant="outline" size="sm">
                      <Plus className="mr-2 h-4 w-4" />
                      Nova Comunidade
                    </Button>
                  }
                />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <FormItem className="flex-1">
                  <FormLabel>Selecionar Comunidade</FormLabel>
                  <Combobox
                    options={communities}
                    value={selectedCommunityId}
                    onSelect={handleCommunitySelect}
                    placeholder="Selecione uma comunidade..."
                  />
                </FormItem>
                {selectedCommunityId &&
                  (() => {
                    const comm = communities.find(
                      c => c.value === selectedCommunityId
                    )?.data;
                    return comm ? (
                      <div className="text-sm text-muted-foreground pt-8">
                        <div className="flex items-center gap-1">
                          <Users className="h-4 w-4" />
                          <span>
                            {comm.title} ({comm.slug})
                          </span>
                        </div>
                      </div>
                    ) : null;
                  })()}
              </div>
            </div>

            {!isEditing && (
              <FormField
                control={form.control}
                name="pixai_token_integration"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Token de Integração Pix Aí</FormLabel>
                    <FormControl>
                      <Input placeholder="Token do Pix Aí" {...field} />
                    </FormControl>
                    <FormDescription>
                      Insira o token de integração do Pix Aí.
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />
            )}

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descrição</FormLabel>
                  <FormControl>
                    <RichTextEditor
                      value={Array.isArray(field.value) ? field.value : []}
                      onChange={field.onChange}
                      placeholder="Descreva os detalhes do evento..."
                    />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </TabsContent>

          <TabsContent value="schedule" className="space-y-6 mt-6">
            {/* Talks Section */}
            <div className="space-y-4 rounded-lg border p-4">
              <div className="flex items-center justify-between">
                <FormLabel className="text-base font-semibold">
                  Palestras (Talks)
                </FormLabel>
                <TalkFormDialog
                  onSave={handleAddTalk}
                  eventId={initialData?.id}
                  onSubmitEvent={handleSaveEventForTalk}
                  trigger={
                    <Button type="button" variant="outline" size="sm">
                      <Plus className="mr-2 h-4 w-4" />
                      Nova Palestra
                    </Button>
                  }
                />
              </div>

              {talks.length === 0 ? (
                <div className="text-sm text-muted-foreground text-center py-8 border border-dashed rounded-md">
                  Nenhuma palestra cadastrada.
                </div>
              ) : (
                <div className="grid gap-4">
                  {talks.map(talk => (
                    <div
                      key={talk.id}
                      className="flex items-start justify-between border p-4 rounded-md"
                    >
                      <div>
                        <h4 className="font-semibold">{talk.title}</h4>
                        <p className="text-sm text-muted-foreground">
                          {talk.subtitle}
                        </p>
                        <div className="flex items-center gap-2 mt-2 text-xs text-muted-foreground">
                          <Calendar className="h-3 w-3" />
                          <span>{talk.occur_date}</span>
                          {talk.speakers?.map(s => (
                            <div
                              key={s.id}
                              className="flex items-center gap-1 ml-2"
                            >
                              <UserIcon className="h-3 w-3" />
                              <span>{s.name}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <TalkFormDialog
                          onSave={updatedTalk => {
                            const newTalks = talks.map(t =>
                              t.id === talk.id ? updatedTalk : t
                            );
                            setTalks(newTalks);
                            form.setValue('talks', newTalks);
                          }}
                          initialData={talk}
                          eventId={initialData?.id}
                          onSubmitEvent={handleSaveEventForTalk}
                          trigger={
                            <Button variant="ghost" size="sm">
                              Editar
                            </Button>
                          }
                        />
                        <Button
                          variant="ghost"
                          size="sm"
                          className="text-destructive hover:text-destructive hover:bg-destructive/10"
                          onClick={() => handleRemoveTalk(talk.id)}
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </TabsContent>

          <TabsContent value="products" className="space-y-6 mt-6">
            <div className="space-y-4 rounded-lg border p-4">
              <div className="flex items-center justify-between">
                <FormLabel className="text-base font-semibold">
                  Produtos & Lotes
                </FormLabel>
                <ProductFormDialog
                  onSave={handleAddProduct}
                  trigger={
                    <Button type="button" variant="outline" size="sm">
                      <Plus className="mr-2 h-4 w-4" />
                      Novo Produto
                    </Button>
                  }
                />
              </div>

              {products.length === 0 ? (
                <div className="text-sm text-muted-foreground text-center py-8 border border-dashed rounded-md">
                  Nenhum produto cadastrado.
                </div>
              ) : (
                <div className="grid gap-4">
                  {products.map(product => (
                    <div
                      key={product.id || product.name}
                      className="border p-4 rounded-md"
                    >
                      <div className="flex items-start justify-between mb-2">
                        <div>
                          <h4 className="font-semibold flex items-center gap-2">
                            {product.name}
                            {!product.enabled && (
                              <span className="text-xs bg-muted px-2 py-0.5 rounded text-muted-foreground">
                                Inativo
                              </span>
                            )}
                          </h4>
                        </div>
                        <Button variant="ghost" size="sm">
                          Editar
                        </Button>
                      </div>

                      {product.batches && product.batches.length > 0 ? (
                        <div className="mt-2 space-y-1">
                          {product.batches.map((batch: any, index: number) => (
                            <div
                              key={index}
                              className="text-sm text-muted-foreground flex items-center gap-2"
                            >
                              <div className="w-2 h-2 rounded-full bg-primary/50" />
                              <span>
                                Lote {batch.batch_number}: R$ {batch.value} (
                                {batch.max_quantity || 'Ilimitado'} un.)
                              </span>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="text-xs text-muted-foreground mt-1 italic">
                          Sem lotes configurados
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </TabsContent>
        </Tabs>

        <div className="flex justify-end gap-4">
          <Button type="button" variant="outline" onClick={() => router.back()}>
            Cancelar
          </Button>
          <Button type="submit" disabled={isLoading}>
            {isLoading ? 'Salvando...' : 'Salvar Evento'}
          </Button>
        </div>
      </form>
    </Form>
  );
}
